"use strict";angular.module("claApp",["ngCookies","ngSanitize","ngRoute","ngAnimate","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("claApp").controller("MainCtrl",["$rootScope","$scope","$window",function(a,b,c){b.data={nodes:{nodes:[],links:[],update:1,windowHeight:c.innerHeight-75}},c.onresize=function(){console.log("ctrl resize"),b.data.nodes.windowHeight=c.innerHeight-75,a.$broadcast("resize")},d3.json("static-linkages.json",function(a,c){function d(a){return e("object"==typeof a.owner?a.owner.id:0)}console.log("Ctrl Update List"),b.list=c,b.list.nodes.forEach(function(a,b){a.id=b,a.hidden=!1,a.icon=a.name.split(":",1)[0]+".png",a.highlight=!1,a.collapsed=!1});var e=d3.scale.category10();b.list.hash_lookup=[],b.list.nodes.forEach(function(a){b.list.hash_lookup[a.id]=a,b.list.hash_lookup[a.name]=a}),b.list.nodes.forEach(function(a){a.owner=b.list.hash_lookup[a.owner],a.color=d(a)}),b.list.links.forEach(function(a){a.source=b.list.hash_lookup[a.source],a.target=b.list.hash_lookup[a.target]}),b.tree={};var f=function(a,b,c){return"undefined"==typeof b.owner?(b.collapsed=!0,b.children=[],c[b.name]=b,c):"undefined"!=typeof c[b.owner.name]?(b.hidden=!0,c[b.owner.name].children.push(b),c):(f(a,b.owner,c),b.hidden=!0,c[b.owner.name].children.push(b),c)};b.list.nodes.forEach(function(a){f(b.list.nodes,a,b.tree)}),b.$apply()}),b.noOfPages=function(){return void 0!==b.filteredEvents?Math.ceil(b.filteredEvents.length/b.pageSize):1},b.showPagination=function(){var a;return a=b.noOfPages()>1?!0:!1},b.currentPage>b.noOfPages()&&(b.currentPage=b.noOfPages()),b.setPage=function(a){b.currentPage=a},b.$watch("data.nodes.update",function(){})}]),angular.module("claApp").directive("forceDiagram",function(){return{template:'<div id="viz" ></div>',restrict:"E",scope:{nodes:"=",list:"="},link:function(a,b){function c(){i.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}function d(){j=d3.select("#nodeg").selectAll(".node"),k=d3.select("#linkg").selectAll(".link"),a.nodes.hash_lookup=[],a.nodes.nodes.forEach(function(b){a.nodes.hash_lookup[b.id]=b}),a.list.nodes.forEach(function(b){b.hidden===!0?-1!==a.nodes.nodes.indexOf(b)&&a.nodes.nodes.splice(a.nodes.nodes.indexOf(b),1):-1===a.nodes.nodes.indexOf(b)&&a.nodes.nodes.push(b)}),a.list.links.forEach(function(b){b.source.hidden===!0||b.target.hidden===!0?-1!==a.nodes.links.indexOf(b)&&a.nodes.links.splice(a.nodes.links.indexOf(b),1):-1===a.nodes.links.indexOf(b)&&a.nodes.links.push(b)}),k=k.data(a.nodes.links),k.exit().remove(),k.enter().append("line").style("stroke",function(a){return a.source.color}).style("stroke-width","1px").attr("class",function(a){var b="",c="";return"undefined"!=typeof a.source.owner&&(b="o"+a.source.owner.id),"undefined"!=typeof a.target.owner&&(c="o"+a.target.owner.id),"link n"+a.source.id+" n"+a.target.id+" "+b+" "+c}),j=j.data(a.nodes.nodes),j.exit().remove();var b=j.enter().append("g").attr("title",name).attr("class",function(a){return"node n"+a.id}).call(h.drag);b.append("svg:rect").attr("x",-16).attr("y",-16).attr("width",32).attr("height",32).style("stroke",function(a){return a.color}).style("stroke-width",1).attr("class",function(a){return"undefined"!=typeof a.ownerId?"o"+a.ownerId+" n"+a.id:"n"+a.id}).style("stroke-linejoin","round").attr("fill","none"),b.append("svg:image").attr("class",function(a){return"square n"+a.id}).attr("xlink:href",function(a){return"images/"+a.icon}).attr("x",-16).attr("y",-16).attr("width",32).attr("height",32).attr("id",function(a){return"n"+a.id}).attr("class",function(a){return"n"+a.id}).append("svg:title").text(function(a){return a.name}),j.on("mouseover",function(b){b.highlight=!0,d3.selectAll(".n"+b.id).style("stroke-width","4px"),a.$apply()}),j.on("mouseout",function(b){b.highlight=!1,d3.selectAll(".n"+b.id).style("stroke-width","1px"),a.$apply()}),h.nodes(a.nodes.nodes).links(a.nodes.links).start()}function e(){"undefined"!=typeof b[0].parentNode.clientWidth&&(f=b[0].parentNode.clientWidth-20),"undefined"!=typeof a.nodes.windowHeight&&(g=a.nodes.windowHeight),d3.select("#viz svg").attr("width",f).attr("height",g)}var f=(d3.scale.category10(),500),g=500;"undefined"!=typeof b[0].parentNode.clientWidth&&(f=b[0].parentNode.clientWidth),"undefined"!=typeof a.nodes.windowHeight&&(g=a.nodes.windowHeight);var h=d3.layout.force().gravity(.05).alpha(.8).charge(-1e3).linkDistance(200).size([f,g]).on("tick",function(){j.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),k.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})}),i=d3.select("#viz").append("svg").attr("width",f).attr("height",g).attr("pointer-events","all");i.append("rect").attr("width","100%").attr("height","100%").call(d3.behavior.zoom().on("zoom",c)).attr("fill","rgba(1,1,1,0)"),i=i.append("g");var j=(i.append("g").attr("id","linkg"),i.append("g").attr("id","nodeg"),d3.select("#nodeg").selectAll(".node")),k=d3.select("#linkg").selectAll(".link");a.$watch("list",function(a,b){a!==b&&(console.log("List updated"),console.log(a),d())}),a.$watch("nodes.update",function(a,b){a!==b&&d()}),a.$on("resize",function(){console.log("resize"),e(),d()})}}}),angular.module("claApp").directive("forceDiagramLegend",function(){return{templateUrl:"views/templates/forceDiagramLegend.html",restrict:"E",scope:{list:"=",nodes:"="},link:function(a){a.$watch("list",function(){"undefined"!=typeof a.list&&(a.currentPage=1,a.pageSize=10,a.maxSize=5,a.noOfPages=5,a.filteredNodes=[],a.predicate="name",a.reverse=!1,a.toggle=function(b){a.list.nodes[a.list.nodes.indexOf(b)].hidden=b.hidden===!1?!0:!1,a.nodes.update=a.nodes.update+1})}),a.$watch("nodes.update",function(){})}}}),angular.module("claApp").filter("startFrom",function(){return function(a,b){return b=+b,void 0!=a?a.slice(b):a}}),angular.module("claApp").directive("treeDiagram",["$http",function(a){return{templateUrl:"views/templates/treeDiagram.html",restrict:"E",scope:{list:"=",nodes:"=",tree:"="},link:function(b){b.toggle=function(a){a.hidden===!1?(b.list.nodes[b.list.nodes.indexOf(a)].hidden=!0,d3.selectAll(".n"+a.id).remove()):b.list.nodes[b.list.nodes.indexOf(a)].hidden=!1,b.nodes.update=b.nodes.update+1},b.collapse=function(a){a.collapsed===!1?(b.list.nodes[b.list.nodes.indexOf(a)].collapsed=!0,b.list.nodes[b.list.nodes.indexOf(a)].hidden=!1,"undefined"!=typeof a.children&&a.children.forEach(function(a){a.hidden=!0,d3.selectAll(".n"+a.id).remove()})):(b.list.nodes[b.list.nodes.indexOf(a)].collapsed=!1,b.list.nodes[b.list.nodes.indexOf(a)].hidden=!0,d3.selectAll(".n"+a.id).remove(),"undefined"!=typeof a.children&&a.children.forEach(function(a){a.hidden=!1,d3.selectAll(".n"+a.id).remove()})),b.nodes.update=b.nodes.update+1},b.openVI=function(b){var c={filename:b.name},d="/links/openfile";a({url:d,method:"POST",timeout:1e4,data:c}).success(function(){console.log("Opening VI in LabVIEW")}).error(function(){})},b.highlight=function(a){a.highlight=!0,d3.selectAll(".n"+a.id).style("stroke-width","4px"),d3.selectAll(".o"+a.id).style("stroke-width","4px")},b.unhighlight=function(a){a.highlight=!1,d3.selectAll(".n"+a.id).style("stroke-width","1px"),d3.selectAll(".o"+a.id).style("stroke-width","1px")}}}}]);