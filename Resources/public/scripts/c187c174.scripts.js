"use strict";angular.module("claApp",["ngCookies","ngSanitize","ngRoute","ngAnimate","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("claApp").controller("MainCtrl",["$scope","$window",function(a,b){a.data={nodes:{nodes:[],links:[],update:1,windowHeight:b.innerHeight}},d3.json("static-linkages.json",function(b,c){function d(a){return e("object"==typeof a.owner?a.owner.id:0)}console.log("Ctrl Update List"),a.list=c,a.list.nodes.forEach(function(a,b){a.id=b,a.hidden=!1,a.icon=a.name.split(":",1)[0]+".png",a.highlight=!1,a.collapsed=!1}),a.list.links.forEach(function(){});var e=d3.scale.category10(),f=[];a.list.nodes.forEach(function(a){f[a.id]=a,f[a.name]=a}),a.list.nodes.forEach(function(a){a.owner=f[a.owner],a.color=d(a)}),a.list.links.forEach(function(a){a.source=f[a.source],a.target=f[a.target]}),a.$apply()}),a.noOfPages=function(){return void 0!==a.filteredEvents?Math.ceil(a.filteredEvents.length/a.pageSize):1},a.showPagination=function(){var b;return b=a.noOfPages()>1?!0:!1},a.currentPage>a.noOfPages()&&(a.currentPage=a.noOfPages()),a.setPage=function(b){a.currentPage=b},a.$watch("data.nodes.update",function(){})}]),angular.module("claApp").directive("forceDiagram",function(){return{template:'<div id="viz" ></div>',restrict:"E",scope:{nodes:"=",list:"="},link:function(a,b){function c(){h.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}function d(){i=d3.select("#nodeg").selectAll(".node"),j=d3.select("#linkg").selectAll(".link"),a.list.nodes.forEach(function(b){b.hidden===!0?-1!==a.nodes.nodes.indexOf(b)&&a.nodes.nodes.splice(a.nodes.nodes.indexOf(b),1):-1===a.nodes.nodes.indexOf(b)&&a.nodes.nodes.push(b)}),a.list.links.forEach(function(b){var c={source:b.source,target:b.target,value:b.value};b.source.hidden===!0||b.target.hidden===!0?(-1!==a.nodes.links.indexOf(b)&&a.nodes.links.splice(a.nodes.links.indexOf(b),1),"undefined"!=typeof b.source.owner&&b.source.owner.collapsed===!0&&(c.source=b.source.owner),"undefined"!=typeof b.target.owner&&b.target.owner.collapsed===!0&&(c.target=b.target.owner),-1===a.nodes.links.indexOf(c)&&console.log(c)):-1===a.nodes.links.indexOf(b)&&a.nodes.links.push(b)}),j=j.data(a.nodes.links),j.exit().remove(),j.enter().append("line").style("stroke",function(a){return a.source.color}).style("stroke-width","1px").attr("class",function(a){return"link n"+a.source.id+" n"+a.target.id}),i=i.data(a.nodes.nodes),i.exit().remove(),i.enter().append("g").attr("title",name).attr("class",function(a){return"node n"+a.id}).call(g.drag),i.append("svg:rect").attr("x",-16).attr("y",-16).attr("width",32).attr("height",32).style("stroke",function(a){return a.color}).style("stroke-width",1).attr("class",function(a){return"n"+a.id}).style("stroke-linejoin","round").attr("fill","none"),i.append("svg:image").attr("class",function(a){return"square n"+a.id}).attr("xlink:href",function(a){return"images/"+a.icon}).attr("x",-16).attr("y",-16).attr("width",32).attr("height",32).attr("id",function(a){return"n"+a.id}).attr("class",function(a){return"n"+a.id}).append("svg:title").text(function(a){return a.name}),i.on("mouseover",function(b){b.highlight=!0,d3.selectAll(".n"+b.id).style("stroke-width","4px"),a.$apply()}),i.on("mouseout",function(b){b.highlight=!1,d3.selectAll(".n"+b.id).style("stroke-width","1px"),a.$apply()}),g.nodes(a.nodes.nodes).links(a.nodes.links).start()}var e=(d3.scale.category10(),500),f=500;"undefined"!=typeof b[0].parentNode.clientWidth&&(e=b[0].parentNode.clientWidth),"undefined"!=typeof a.nodes.windowHeight&&(f=a.nodes.windowHeight-100);var g=d3.layout.force().gravity(.05).alpha(.05).charge(-600).linkDistance(100).size([e,f]).on("tick",function(){i.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),j.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y})}),h=d3.select("#viz").append("svg").attr("width",e).attr("height",f).attr("pointer-events","all");h.append("rect").attr("width","100%").attr("height","100%").call(d3.behavior.zoom().on("zoom",c)).attr("fill","rgba(1,1,1,0)"),h=h.append("g");var i=(h.append("g").attr("id","linkg"),h.append("g").attr("id","nodeg"),d3.select("#nodeg").selectAll(".node")),j=d3.select("#linkg").selectAll(".link");a.$watch("list",function(a,b){a!==b&&(console.log("List updated"),d())}),a.$watch("nodes.update",function(a,b){a!==b&&d()})}}}),angular.module("claApp").directive("forceDiagramLegend",function(){return{templateUrl:"views/templates/forceDiagramLegend.html",restrict:"E",scope:{list:"=",nodes:"="},link:function(a){a.$watch("list",function(){"undefined"!=typeof a.list&&(a.currentPage=1,a.pageSize=10,a.maxSize=5,a.noOfPages=5,a.filteredNodes=[],a.predicate="name",a.reverse=!1,a.toggle=function(b){a.list.nodes[a.list.nodes.indexOf(b)].hidden=b.hidden===!1?!0:!1,a.nodes.update=a.nodes.update+1})}),a.$watch("nodes.update",function(){})}}}),angular.module("claApp").filter("startFrom",function(){return function(a,b){return b=+b,void 0!=a?a.slice(b):a}}),angular.module("claApp").directive("treeDiagram",["$http",function(a){return{templateUrl:"views/templates/treeDiagram.html",restrict:"E",scope:{list:"=",nodes:"="},link:function(b){b.$watch("list",function(){if("undefined"!=typeof b.list){b.isCollapsed=!0,b.treeOut={};var a=function(b,c,d){return"undefined"==typeof c.owner?(c.children=[],d[c.name]=c,d):"undefined"!=typeof d[c.owner.name]?(d[c.owner.name].children.push(c),d):a(b,c.owner,d)};b.list.nodes.forEach(function(c){a(b.list.nodes,c,b.treeOut)})}}),b.toggle=function(a){a.hidden===!1?(b.list.nodes[b.list.nodes.indexOf(a)].hidden=!0,d3.selectAll(".n"+a.id).remove()):b.list.nodes[b.list.nodes.indexOf(a)].hidden=!1,b.nodes.update=b.nodes.update+1},b.collapse=function(a){a.collapsed===!1?(b.list.nodes[b.list.nodes.indexOf(a)].collapsed=!0,"undefined"!=typeof a.children&&a.children.forEach(function(a){a.hidden=!0,d3.selectAll(".n"+a.id).remove()})):(b.list.nodes[b.list.nodes.indexOf(a)].collapsed=!1,"undefined"!=typeof a.children&&a.children.forEach(function(a){a.hidden=!1,d3.selectAll(".n"+a.id).remove()})),b.nodes.update=b.nodes.update+1},b.openVI=function(b){var c={filename:b.name},d="/links/openfile";a({url:d,method:"POST",timeout:1e4,data:c}).success(function(){console.log("Opening VI in LabVIEW")}).error(function(){})},b.highlight=function(a){a.highlight=!0,d3.selectAll(".n"+a.id).style("stroke-width","4px")},b.unhighlight=function(a){a.highlight=!1,d3.selectAll(".n"+a.id).style("stroke-width","1px")}}}}]);